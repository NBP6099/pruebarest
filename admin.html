<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BARGON - Panel de Pedidos Online</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Montserrat', Arial, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 20px; }
    .admin-header { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 30px rgba(52, 152, 219, 0.3); }
    .admin-header h1 { color: white; font-size: 2rem; font-weight: 800; }
    .admin-header p { color: white; opacity: 0.9; margin-top: 5px; }

    .nav-buttons { display: flex; gap: 15px; margin-bottom: 30px; }
    .nav-btn { padding: 12px 24px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 25px; color: white; text-decoration: none; font-weight: 700; transition: all 0.3s; }
    .nav-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
    .nav-btn.active { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-color: #3498db; }

    .date-selector { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .date-nav-btn { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s; }
    .date-nav-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); }
    .date-input { padding: 12px; border-radius: 8px; border: 2px solid #3498db; background: rgba(255,255,255,0.9); font-weight: 600; }
    .current-date { color: #3498db; font-size: 1.2rem; font-weight: 700; flex: 1; text-align: center; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s ease; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3); }
    .stat-number { font-size: 2.5rem; font-weight: 900; color: #3498db; }
    .stat-label { color: #ecf0f1; margin-top: 8px; font-size: 0.9rem; }

    .filter-tabs { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
    .filter-btn { padding: 12px 24px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 25px; color: #ecf0f1; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
    .filter-btn:hover, .filter-btn.active { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-color: #3498db; color: white; }

    .orders-container { display: grid; gap: 20px; }
    .order-card { background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); animation: slideIn 0.5s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    .order-card.new { border-left: 5px solid #3498db; }

    .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    .order-id { font-size: 1.3rem; font-weight: 800; color: #1a1a2e; }
    .order-time { color: #7f8c8d; font-size: 0.9rem; }
    .order-status { padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; }
    .status-pending { background: #f39c12; color: #1a1a2e; }
    .status-preparing { background: #3498db; color: #fff; }
    .status-ready { background: #27ae60; color: #fff; }
    .status-delivered { background: #95a5a6; color: #fff; }

    .order-info { background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 20px; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
    .info-label { color: #7f8c8d; font-weight: 600; }
    .info-value { color: #2c3e50; font-weight: 700; }

    .order-items { margin: 20px 0; }
    .order-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #ecf0f1; border-radius: 8px; margin-bottom: 8px; }
    .item-name { font-weight: 600; color: #2c3e50; }
    .item-qty { background: #3498db; color: white; padding: 4px 12px; border-radius: 15px; font-weight: 700; font-size: 0.85rem; margin: 0 10px; }
    .item-price { font-weight: 800; color: #3498db; font-size: 1.1rem; }

    .order-total { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 16px; border-radius: 12px; margin-top: 20px; }
    .total-row { display: flex; justify-content: space-between; color: #ecf0f1; margin-bottom: 8px; }
    .total-amount { font-size: 1.8rem; font-weight: 900; color: #3498db; }

    .order-actions { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
    .action-btn { flex: 1; padding: 12px 20px; border: none; border-radius: 25px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; min-width: 140px; }
    .btn-accept { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: #fff; }
    .btn-ready { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: #fff; }
    .btn-complete { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: #3498db; }
    .btn-reject { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: #fff; }
    .action-btn:hover { transform: translateY(-2px); }

    .notification { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: #fff; padding: 16px 24px; border-radius: 12px; box-shadow: 0 8px 30px rgba(39, 174, 96, 0.4); z-index: 1000; animation: slideIn 0.5s ease; max-width: 350px; }
    .notification.error { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }

    .empty-state { text-align: center; padding: 60px 20px; color: #ecf0f1; }
    .empty-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
    .empty-text { font-size: 1.2rem; opacity: 0.8; }

    @media (max-width: 768px) {
      .order-header { flex-direction: column; }
      .order-actions { flex-direction: column; }
      .action-btn { width: 100%; }
      .date-selector { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div class="admin-header">
    <h1>üç¥ BARGON - Pedidos Online</h1>
    <p>Gesti√≥n de pedidos de recogida y delivery</p>
  </div>

  <div class="nav-buttons">
    <a href="admin.html" class="nav-btn active">üì¶ Pedidos Online</a>
    <a href="admin_mesas.html" class="nav-btn">üçΩÔ∏è Gesti√≥n de Mesas</a>
  </div>

  <div class="date-selector">
    <button class="date-nav-btn" onclick="changeDay(-1)">‚óÄ Anterior</button>
    <input type="date" id="date-picker" class="date-input" onchange="selectDate()">
    <div class="current-date" id="current-date-display"></div>
    <button class="date-nav-btn" onclick="changeDay(1)">Siguiente ‚ñ∂</button>
    <button class="date-nav-btn" onclick="goToToday()">üìÖ Hoy</button>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="total-orders">0</div>
      <div class="stat-label">Pedidos del D√≠a</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="pending-count">0</div>
      <div class="stat-label">Pendientes</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="preparing-count">0</div>
      <div class="stat-label">En Preparaci√≥n</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="revenue-today">0‚Ç¨</div>
      <div class="stat-label">Ingresos</div>
    </div>
  </div>

  <div class="filter-tabs">
    <button class="filter-btn active" onclick="filterOrders('all')">Todos</button>
    <button class="filter-btn" onclick="filterOrders('pending')">Pendientes</button>
    <button class="filter-btn" onclick="filterOrders('preparing')">Preparando</button>
    <button class="filter-btn" onclick="filterOrders('ready')">Listos</button>
    <button class="filter-btn" onclick="filterOrders('delivered')">Entregados</button>
  </div>

  <div id="orders-container" class="orders-container">
    <div class="empty-state">
      <div class="empty-icon">üì¶</div>
      <div class="empty-text">Cargando pedidos...</div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDjbJFg-GeioAxBAf3wh9zQ4M-CB7klx1Y",
      authDomain: "gonbar-8cd74.firebaseapp.com",
      databaseURL: "https://gonbar-8cd74-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gonbar-8cd74",
      storageBucket: "gonbar-8cd74.firebasestorage.app",
      messagingSenderId: "865095320231",
      appId: "1:865095320231:web:d6598f1ddfd93672c39182"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let currentFilter = 'all';
    let orders = {};
    let currentDate = new Date();

    initializeDatePicker();

    function initializeDatePicker() {
      const picker = document.getElementById('date-picker');
      picker.value = formatDateForInput(currentDate);
      updateDateDisplay();
      loadOrdersForDate(currentDate);
    }

    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function updateDateDisplay() {
      const display = document.getElementById('current-date-display');
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      display.textContent = currentDate.toLocaleDateString('es-ES', options);
    }

    function changeDay(delta) {
      currentDate.setDate(currentDate.getDate() + delta);
      document.getElementById('date-picker').value = formatDateForInput(currentDate);
      updateDateDisplay();
      loadOrdersForDate(currentDate);
    }

    function selectDate() {
      const picker = document.getElementById('date-picker');
      currentDate = new Date(picker.value + 'T00:00:00');
      updateDateDisplay();
      loadOrdersForDate(currentDate);
    }

    function goToToday() {
      currentDate = new Date();
      document.getElementById('date-picker').value = formatDateForInput(currentDate);
      updateDateDisplay();
      loadOrdersForDate(currentDate);
    }

    function loadOrdersForDate(date) {
      const startOfDay = new Date(date);
      startOfDay.setHours(0, 0, 0, 0);
      const endOfDay = new Date(date);
      endOfDay.setHours(23, 59, 59, 999);

      orders = {};

      database.ref('orders')
        .orderByChild('timestamp')
        .startAt(startOfDay.getTime())
        .endAt(endOfDay.getTime())
        .once('value', (snapshot) => {
          snapshot.forEach((childSnapshot) => {
            const order = childSnapshot.val();
            orders[childSnapshot.key] = { ...order, id: childSnapshot.key };
          });
          renderOrders();
          updateStats();
        });
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    database.ref('orders').orderByChild('timestamp').startAt(today.getTime()).on('child_added', (snapshot) => {
      if (isToday(currentDate)) {
        const order = snapshot.val();
        orders[snapshot.key] = { ...order, id: snapshot.key };
        if (order.status === 'pending') {
          showNotification('üîî Nuevo pedido recibido!', 'success');
          playNotificationSound();
        }
        renderOrders();
        updateStats();
      }
    });

    database.ref('orders').on('child_changed', (snapshot) => {
      if (orders[snapshot.key]) {
        orders[snapshot.key] = { ...snapshot.val(), id: snapshot.key };
        renderOrders();
        updateStats();
      }
    });

    function isToday(date) {
      const today = new Date();
      return date.getDate() === today.getDate() &&
             date.getMonth() === today.getMonth() &&
             date.getFullYear() === today.getFullYear();
    }

    function renderOrders() {
      const container = document.getElementById('orders-container');
      const filteredOrders = Object.values(orders).filter(order => {
        if (currentFilter === 'all') return true;
        return order.status === currentFilter;
      }).sort((a, b) => b.timestamp - a.timestamp);

      if (filteredOrders.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <div class="empty-text">No hay pedidos</div>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredOrders.map(order => createOrderCard(order)).join('');
    }

    function createOrderCard(order) {
      const statusClass = `status-${order.status}`;
      const statusText = {
        'pending': 'Pendiente',
        'preparing': 'Preparando',
        'ready': 'Listo',
        'delivered': 'Entregado'
      }[order.status] || order.status;

      const timeAgo = formatTimeAgo(order.timestamp);
      const isNew = order.status === 'pending' ? ' new' : '';

      return `
        <div class="order-card${isNew}">
          <div class="order-header">
            <div>
              <div class="order-id">Pedido #${order.orderNumber || order.id.substr(0, 8)}</div>
              <div class="order-time">‚è∞ ${timeAgo}</div>
            </div>
            <div class="order-status ${statusClass}">${statusText}</div>
          </div>

          <div class="order-info">
            <div class="info-row">
              <span class="info-label">üë§ Cliente:</span>
              <span class="info-value">${order.customerName}</span>
            </div>
            <div class="info-row">
              <span class="info-label">üìû Tel√©fono:</span>
              <span class="info-value">${order.customerPhone}</span>
            </div>
            <div class="info-row">
              <span class="info-label">üì¶ Tipo:</span>
              <span class="info-value">${formatServiceType(order.serviceType)}</span>
            </div>
            ${order.notes ? `
              <div class="info-row">
                <span class="info-label">üìù Notas:</span>
                <span class="info-value">${order.notes}</span>
              </div>
            ` : ''}
          </div>

          <div class="order-items">
            ${order.items.map(item => `
              <div class="order-item">
                <span class="item-name">${item.name}</span>
                <div>
                  <span class="item-qty">x${item.quantity}</span>
                  <span class="item-price">${(item.price * item.quantity).toFixed(2)}‚Ç¨</span>
                </div>
              </div>
            `).join('')}
          </div>

          <div class="order-total">
            <div class="total-row">
              <span>Subtotal:</span>
              <span>${order.subtotal.toFixed(2)}‚Ç¨</span>
            </div>
            <div class="total-row">
              <span>Descuento:</span>
              <span style="color: #27ae60;">-${order.discount.toFixed(2)}‚Ç¨</span>
            </div>
            <div class="total-row" style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px; margin-top: 8px;">
              <span style="font-size: 1.2rem;"><strong>TOTAL:</strong></span>
              <span class="total-amount">${order.total.toFixed(2)}‚Ç¨</span>
            </div>
          </div>

          <div class="order-actions">
            ${getActionButtons(order)}
          </div>
        </div>
      `;
    }

    function getActionButtons(order) {
      switch(order.status) {
        case 'pending':
          return `
            <button class="action-btn btn-accept" onclick="updateOrderStatus('${order.id}', 'preparing')">
              ‚úÖ Aceptar
            </button>
            <button class="action-btn btn-reject" onclick="rejectOrder('${order.id}')">
              ‚ùå Rechazar
            </button>
          `;
        case 'preparing':
          return `
            <button class="action-btn btn-ready" onclick="updateOrderStatus('${order.id}', 'ready')">
              üîî Listo
            </button>
          `;
        case 'ready':
          return `
            <button class="action-btn btn-complete" onclick="updateOrderStatus('${order.id}', 'delivered')">
              ‚úÖ Entregado
            </button>
          `;
        case 'delivered':
          return `<span style="color: #27ae60; font-weight: 700;">‚úì Completado</span>`;
        default:
          return '';
      }
    }

    function updateOrderStatus(orderId, newStatus) {
      database.ref(`orders/${orderId}`).update({
        status: newStatus,
        lastUpdated: Date.now()
      }).then(() => {
        showNotification(`Pedido actualizado`, 'success');
      });
    }

    function rejectOrder(orderId) {
      if (confirm('¬øRechazar pedido?')) {
        database.ref(`orders/${orderId}`).remove()
          .then(() => {
            delete orders[orderId];
            renderOrders();
            updateStats();
            showNotification('Pedido rechazado', 'error');
          });
      }
    }

    function filterOrders(status) {
      currentFilter = status;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      renderOrders();
    }

    function updateStats() {
      const dayOrders = Object.values(orders);

      document.getElementById('total-orders').textContent = dayOrders.length;
      document.getElementById('pending-count').textContent = 
        dayOrders.filter(o => o.status === 'pending').length;
      document.getElementById('preparing-count').textContent = 
        dayOrders.filter(o => o.status === 'preparing').length;

      const revenue = dayOrders.reduce((sum, o) => sum + o.total, 0);
      document.getElementById('revenue-today').textContent = `${revenue.toFixed(2)}‚Ç¨`;
    }

    function formatTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'Hace unos segundos';
      if (seconds < 3600) return `Hace ${Math.floor(seconds / 60)} min`;
      return `Hace ${Math.floor(seconds / 3600)}h`;
    }

    function formatServiceType(type) {
      const types = {
        'delivery': 'üè† Delivery',
        'pickup': 'üèÉ Recogida',
        'table': 'üçΩÔ∏è En mesa'
      };
      return types[type] || type;
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => notification.remove(), 4000);
    }

    function playNotificationSound() {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjJ+zfPTfjMGJXTO8tmMPQoVYLTp66hVFApGn+DyvmwhBjJ+zfPTfjMGJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjJ+zfPTfjMGJHfH8N2QQAoUYLTp66hVFApGn+DyvmwhBjJ+zfPTfjMGJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjJ+zfPTfjMGJHfH8N2QQAo=');
      audio.play().catch(() => {});
    }

    setInterval(renderOrders, 60000);
  </script>
</body>
</html>