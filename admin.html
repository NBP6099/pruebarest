<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BARGON - Pedidos Recogida</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Montserrat', Arial, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 20px; }
    .admin-header { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 30px rgba(52, 152, 219, 0.3); }
    .admin-header h1 { color: white; font-size: 2rem; font-weight: 800; }

    .nav-buttons { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
    .nav-btn { padding: 12px 24px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 25px; color: white; text-decoration: none; font-weight: 700; transition: all 0.3s; }
    .nav-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
    .nav-btn.active { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-color: #3498db; }

    .date-selector { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .date-nav-btn { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s; }
    .date-nav-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); }
    .date-input { padding: 12px; border-radius: 8px; border: 2px solid #3498db; background: rgba(255,255,255,0.9); font-weight: 600; }
    .current-date { color: #3498db; font-size: 1.2rem; font-weight: 700; flex: 1; text-align: center; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 20px; text-align: center; }
    .stat-number { font-size: 2.5rem; font-weight: 900; color: #3498db; }
    .stat-label { color: #ecf0f1; margin-top: 8px; font-size: 0.9rem; }

    .orders-container { display: grid; gap: 20px; }
    .order-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); position: relative; }
    .order-card.new { border-left: 5px solid #f39c12; }
    .order-header { display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; }
    .order-id { font-size: 1.3rem; font-weight: 800; color: #1a1a2e; }
    .order-status { padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 0.85rem; }
    .status-pending { background: #f39c12; color: white; }
    .status-preparing { background: #3498db; color: white; }
    .status-ready { background: #27ae60; color: white; }

    .order-info { background: #f8f9fa; padding: 16px; border-radius: 12px; margin: 15px 0; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .info-label { color: #7f8c8d; font-weight: 600; }
    .info-value { color: #2c3e50; font-weight: 700; }

    .order-items { margin: 20px 0; }
    .order-item { display: flex; justify-content: space-between; padding: 12px; background: #ecf0f1; border-radius: 8px; margin-bottom: 8px; }
    .item-qty { background: #3498db; color: white; padding: 4px 12px; border-radius: 15px; font-weight: 700; margin: 0 10px; }

    .order-total { background: #1a1a2e; color: white; padding: 16px; border-radius: 12px; }
    .total-amount { font-size: 1.8rem; font-weight: 900; color: #3498db; }

    .order-actions { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
    .action-btn { flex: 1; padding: 12px 20px; border: none; border-radius: 25px; font-weight: 700; cursor: pointer; transition: all 0.3s; min-width: 140px; }
    .btn-accept { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; }
    .btn-ready { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
    .btn-print { background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: #1a1a2e; }
    .btn-reject { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }

    .ticket-preview { background: white; padding: 30px; font-family: 'Courier New', monospace; max-width: 300px; margin: 20px auto; border: 2px dashed #95a5a6; display: none; }
    .ticket-header { text-align: center; border-bottom: 2px solid #2c3e50; padding-bottom: 15px; margin-bottom: 15px; }
    .ticket-logo { font-size: 2rem; font-weight: 900; color: #3498db; letter-spacing: 2px; }
    .ticket-info { font-size: 0.85rem; color: #7f8c8d; }
    .ticket-separator { border-top: 1px dashed #95a5a6; margin: 15px 0; }
    .ticket-item { display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.9rem; }
    .ticket-total { font-size: 1.2rem; font-weight: 900; border-top: 2px solid #2c3e50; padding-top: 10px; margin-top: 10px; }
    .ticket-footer { text-align: center; margin-top: 15px; font-size: 0.85rem; color: #7f8c8d; }

    @media print {
      body * { visibility: hidden; }
      .ticket-preview, .ticket-preview * { visibility: visible; }
      .ticket-preview { position: fixed; left: 0; top: 0; width: 80mm; margin: 0; padding: 10px; border: none; }
    }

    .empty-state { text-align: center; padding: 60px 20px; color: #ecf0f1; }
    .notification { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 16px 24px; border-radius: 12px; z-index: 1000; }

    @media (max-width: 768px) {
      .date-selector { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div class="admin-header">
    <h1>üèÉ BARGON - Pedidos de Recogida</h1>
    <p style="color: white; opacity: 0.9; margin-top: 5px;">Pedidos para llevar</p>
  </div>

  <div class="nav-buttons">
    <a href="cocina.html" class="nav-btn">üë®‚Äçüç≥ Cocina</a>
    <a href="admin.html" class="nav-btn active">üèÉ Pedidos Recogida</a>
    <a href="admin_mesas.html" class="nav-btn">üçΩÔ∏è Gesti√≥n de Mesas</a>
  </div>

  <div class="date-selector">
    <button class="date-nav-btn" onclick="changeDay(-1)">‚óÄ Anterior</button>
    <input type="date" id="date-picker" class="date-input" onchange="selectDate()">
    <div class="current-date" id="current-date-display"></div>
    <button class="date-nav-btn" onclick="changeDay(1)">Siguiente ‚ñ∂</button>
    <button class="date-nav-btn" onclick="goToToday()">üìÖ Hoy</button>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="total-orders">0</div>
      <div class="stat-label">Pedidos del D√≠a</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="pending-count">0</div>
      <div class="stat-label">Pendientes</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="ready-count">0</div>
      <div class="stat-label">Listos</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="revenue">0‚Ç¨</div>
      <div class="stat-label">Ingresos del D√≠a</div>
    </div>
  </div>

  <div id="orders-container" class="orders-container">
    <div class="empty-state">
      <div style="font-size: 4rem; opacity: 0.5;">üì¶</div>
      <div style="font-size: 1.2rem;">Cargando pedidos...</div>
    </div>
  </div>

  <div class="ticket-preview" id="ticket-preview">
    <div class="ticket-header">
      <div class="ticket-logo">BARGON</div>
      <div class="ticket-info">Plaza Mayor - Madrid</div>
      <div class="ticket-info">Tel: +34 634 056 627</div>
      <div class="ticket-info" id="ticket-date"></div>
    </div>
    <div class="ticket-separator"></div>
    <div style="text-align: center; font-weight: 900; font-size: 1.2rem; margin: 10px 0;">
      üèÉ RECOGIDA
    </div>
    <div class="ticket-separator"></div>
    <div><strong>Cliente:</strong> <span id="ticket-customer"></span></div>
    <div><strong>Tel√©fono:</strong> <span id="ticket-phone"></span></div>
    <div class="ticket-separator"></div>
    <div id="ticket-items"></div>
    <div class="ticket-total">
      <div class="ticket-item">
        <span>TOTAL:</span>
        <span id="ticket-total">0.00‚Ç¨</span>
      </div>
    </div>
    <div class="ticket-footer">
      <p>¬°Gracias por su visita!</p>
      <p>www.bargon.es</p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyDjbJFg-GeioAxBAf3wh9zQ4M-CB7klx1Y",
      authDomain: "gonbar-8cd74.firebaseapp.com",
      databaseURL: "https://gonbar-8cd74-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gonbar-8cd74",
      storageBucket: "gonbar-8cd74.firebasestorage.app",
      messagingSenderId: "865095320231",
      appId: "1:865095320231:web:d6598f1ddfd93672c39182"
    };

    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();

    var orders = {};
    var currentDate = new Date();

    initializeDatePicker();

    function initializeDatePicker() {
      var picker = document.getElementById('date-picker');
      picker.value = formatDateForInput(currentDate);
      updateDateDisplay();
      loadOrdersForDate(currentDate);
    }

    function formatDateForInput(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function updateDateDisplay() {
      var display = document.getElementById('current-date-display');
      var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      display.textContent = currentDate.toLocaleDateString('es-ES', options);
    }

    function changeDay(delta) {
      currentDate.setDate(currentDate.getDate() + delta);
      document.getElementById('date-picker').value = formatDateForInput(currentDate);
      updateDateDisplay();
      loadOrdersForDate(currentDate);
    }

    function selectDate() {
      var picker = document.getElementById('date-picker');
      currentDate = new Date(picker.value + 'T00:00:00');
      updateDateDisplay();
      loadOrdersForDate(currentDate);
    }

    function goToToday() {
      currentDate = new Date();
      document.getElementById('date-picker').value = formatDateForInput(currentDate);
      updateDateDisplay();
      loadOrdersForDate(currentDate);
    }

    function loadOrdersForDate(date) {
      var startOfDay = new Date(date);
      startOfDay.setHours(0, 0, 0, 0);
      var endOfDay = new Date(date);
      endOfDay.setHours(23, 59, 59, 999);

      orders = {};

      database.ref('orders')
        .orderByChild('timestamp')
        .startAt(startOfDay.getTime())
        .endAt(endOfDay.getTime())
        .once('value', function(snapshot) {
          snapshot.forEach(function(childSnapshot) {
            var order = childSnapshot.val();
            if (order.serviceType === 'pickup') {
              orders[childSnapshot.key] = order;
              orders[childSnapshot.key].id = childSnapshot.key;
            }
          });
          renderOrders();
          updateStats();
        });
    }

    var today = new Date();
    today.setHours(0, 0, 0, 0);

    database.ref('orders').orderByChild('timestamp').startAt(today.getTime()).on('child_added', function(snapshot) {
      if (isToday(currentDate)) {
        var order = snapshot.val();
        if (order.serviceType === 'pickup') {
          orders[snapshot.key] = order;
          orders[snapshot.key].id = snapshot.key;
          if (order.status === 'pending') {
            showNotification('üîî Nuevo pedido de recogida!');
          }
          renderOrders();
          updateStats();
        }
      }
    });

    database.ref('orders').on('child_changed', function(snapshot) {
      if (orders[snapshot.key]) {
        orders[snapshot.key] = snapshot.val();
        orders[snapshot.key].id = snapshot.key;
        renderOrders();
        updateStats();
      }
    });

    function isToday(date) {
      var now = new Date();
      return date.getDate() === now.getDate() &&
             date.getMonth() === now.getMonth() &&
             date.getFullYear() === now.getFullYear();
    }

    function renderOrders() {
      var container = document.getElementById('orders-container');
      var ordersList = [];
      for (var key in orders) {
        ordersList.push(orders[key]);
      }
      ordersList.sort(function(a, b) { return b.timestamp - a.timestamp; });

      if (ordersList.length === 0) {
        container.innerHTML = '<div class="empty-state"><div style="font-size: 4rem; opacity: 0.5;">üì¶</div><div style="font-size: 1.2rem;">No hay pedidos de recogida este d√≠a</div></div>';
        return;
      }

      var html = '';
      for (var i = 0; i < ordersList.length; i++) {
        var order = ordersList[i];
        var statusText = order.status === 'pending' ? 'Pendiente' : (order.status === 'preparing' ? 'Preparando' : 'Listo');

        html += '<div class="order-card ' + (order.status === 'pending' ? 'new' : '') + '">';
        html += '<div class="order-header">';
        html += '<div class="order-id">Pedido #' + (order.orderNumber || order.id.substr(0, 8)) + '</div>';
        html += '<div class="order-status status-' + order.status + '">' + statusText + '</div>';
        html += '</div>';

        html += '<div class="order-info">';
        html += '<div class="info-row"><span class="info-label">üë§ Cliente:</span><span class="info-value">' + order.customerName + '</span></div>';
        html += '<div class="info-row"><span class="info-label">üìû Tel√©fono:</span><span class="info-value">' + order.customerPhone + '</span></div>';
        html += '<div class="info-row"><span class="info-label">‚è∞ Hora:</span><span class="info-value">' + new Date(order.timestamp).toLocaleTimeString('es-ES') + '</span></div>';
        if (order.notes) {
          html += '<div class="info-row"><span class="info-label">üìù Notas:</span><span class="info-value">' + order.notes + '</span></div>';
        }
        html += '</div>';

        html += '<div class="order-items">';
        for (var j = 0; j < order.items.length; j++) {
          var item = order.items[j];
          var itemTotal = item.price * item.quantity;
          html += '<div class="order-item">';
          html += '<span>' + item.name + '</span>';
          html += '<div><span class="item-qty">x' + item.quantity + '</span>';
          html += '<span style="font-weight: 800; color: #3498db;">' + itemTotal.toFixed(2) + '‚Ç¨</span></div>';
          html += '</div>';
        }
        html += '</div>';

        html += '<div class="order-total">';
        html += '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span>Subtotal:</span><span>' + order.subtotal.toFixed(2) + '‚Ç¨</span></div>';
        html += '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span>Descuento:</span><span style="color: #27ae60;">-' + order.discount.toFixed(2) + '‚Ç¨</span></div>';
        html += '<div style="display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;">';
        html += '<span style="font-size: 1.2rem;"><strong>TOTAL:</strong></span>';
        html += '<span class="total-amount">' + order.total.toFixed(2) + '‚Ç¨</span></div>';
        html += '</div>';

        html += '<div class="order-actions">';
        if (order.status === 'pending') {
          html += '<button class="action-btn btn-accept" onclick="updateStatus(\'' + order.id + '\', \'preparing\')">‚úÖ Aceptar</button>';
          html += '<button class="action-btn btn-reject" onclick="rejectOrder(\'' + order.id + '\')">‚ùå Rechazar</button>';
        } else if (order.status === 'preparing') {
          html += '<button class="action-btn btn-ready" onclick="updateStatus(\'' + order.id + '\', \'ready\')">üîî Marcar Listo</button>';
        } else {
          html += '<span style="color: #27ae60; font-weight: 700;">‚úì Listo para recoger</span>';
        }
        html += '<button class="action-btn btn-print" onclick="printTicket(\'' + order.id + '\')">üñ®Ô∏è Imprimir Ticket</button>';
        html += '</div>';
        html += '</div>';
      }

      container.innerHTML = html;
    }

    function updateStatus(orderId, newStatus) {
      database.ref('orders/' + orderId).update({ status: newStatus })
        .then(function() { 
          showNotification('Estado actualizado'); 
        });
    }

    function rejectOrder(orderId) {
      if (confirm('¬øRechazar pedido?')) {
        database.ref('orders/' + orderId).remove();
      }
    }

    function printTicket(orderId) {
      var order = orders[orderId];
      if (!order) return;

      document.getElementById('ticket-date').textContent = new Date(order.timestamp).toLocaleString('es-ES');
      document.getElementById('ticket-customer').textContent = order.customerName;
      document.getElementById('ticket-phone').textContent = order.customerPhone;

      var itemsHtml = '';
      for (var i = 0; i < order.items.length; i++) {
        var item = order.items[i];
        var itemTotal = item.price * item.quantity;
        itemsHtml += '<div class="ticket-item"><span>' + item.quantity + 'x ' + item.name + '</span><span>' + itemTotal.toFixed(2) + '‚Ç¨</span></div>';
      }

      document.getElementById('ticket-items').innerHTML = itemsHtml;
      document.getElementById('ticket-total').textContent = order.total.toFixed(2) + '‚Ç¨';

      document.getElementById('ticket-preview').style.display = 'block';
      setTimeout(function() {
        window.print();
        document.getElementById('ticket-preview').style.display = 'none';
      }, 100);
    }

    function updateStats() {
      var ordersList = [];
      for (var key in orders) {
        ordersList.push(orders[key]);
      }

      var pending = 0;
      var ready = 0;
      var revenue = 0;

      for (var i = 0; i < ordersList.length; i++) {
        if (ordersList[i].status === 'pending') pending++;
        if (ordersList[i].status === 'ready') ready++;
        revenue += ordersList[i].total;
      }

      document.getElementById('total-orders').textContent = ordersList.length;
      document.getElementById('pending-count').textContent = pending;
      document.getElementById('ready-count').textContent = ready;
      document.getElementById('revenue').textContent = revenue.toFixed(2) + '‚Ç¨';
    }

    function showNotification(msg) {
      var div = document.createElement('div');
      div.className = 'notification';
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(function() { 
        div.remove(); 
      }, 3000);
    }
  </script>
</body>
</html>