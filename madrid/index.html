<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BARGON Madrid | Pedidos</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <header>
    <nav>
      <div class="logo"><a href="../">üç¥ BARGON</a></div>
      <ul class="nav-links">
        <li><a href="../">üè† Inicio</a></li>
        <li><a href="../sevilla/">üåü Sevilla</a></li>
        <li><a href="../donbenito/">‚≠ê Don Benito</a></li>
      </ul>
    </nav>
  </header>

  <section class="hero" style="background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?auto=format&fit=crop&w=1400&q=80');">
    <div class="hero-content">
      <span class="hero-badge">‚ú® BARGON Madrid</span>
      <h1 class="hero-title">Sabores de la Capital</h1>
      <p class="hero-subtitle">Recoge tu pedido en Plaza Mayor</p>
    </div>
  </section>

  <main class="container">
    <section class="recommendations-section">
      <div class="section-header">
        <span class="section-badge">‚≠ê Recomendaciones</span>
        <h2>Lo Mejor de BARGON Madrid</h2>
      </div>

      <div class="recommendations-grid">
        <!-- ZERO -->
        <div class="recommendation-card special" style="border: 3px solid #9b59b6;">
          <div class="recommendation-badge limited" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
            ‚ö° LIMITADO
          </div>
          <div class="recommendation-image">
            <img src="https://images.unsplash.com/photo-1604908554274-44cb73d88ab9?auto=format&fit=crop&w=800&q=80" alt="Zero">
          </div>
          <div class="recommendation-content">
            <h3 style="color: #9b59b6;">‚≠ê ZERO</h3>
            <p class="recommendation-description">Experiencia gastron√≥mica √∫nica.</p>
            <div class="recommendation-footer">
              <div class="price-info">
                <span class="price-old">35‚Ç¨</span>
                <span class="price-large">28‚Ç¨</span>
              </div>
              <button class="btn-add-to-order" onclick="addToOrder('Zero', 28, 'zero')">
                ‚ö° A√±adir
              </button>
            </div>
          </div>
        </div>

        <!-- Cocido -->
        <div class="recommendation-card">
          <div class="recommendation-image">
            <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=800&q=80" alt="Cocido">
          </div>
          <div class="recommendation-content">
            <h3>üèÜ Cocido Madrile√±o</h3>
            <p class="recommendation-description">Tradici√≥n de tres vuelcos.</p>
            <div class="recommendation-footer">
              <div class="price-info">
                <span class="price-large">12‚Ç¨</span>
              </div>
              <button class="btn-add-to-order" onclick="addToOrder('Cocido Madrile√±o', 12, 'cocido')">
                üõí A√±adir
              </button>
            </div>
          </div>
        </div>

        <!-- Calamares -->
        <div class="recommendation-card">
          <div class="recommendation-image">
            <img src="https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80" alt="Calamares">
          </div>
          <div class="recommendation-content">
            <h3>ü¶ë Bocadillo Calamares</h3>
            <p class="recommendation-description">Frescos del d√≠a.</p>
            <div class="recommendation-footer">
              <div class="price-info">
                <span class="price-large">7‚Ç¨</span>
              </div>
              <button class="btn-add-to-order" onclick="addToOrder('Bocadillo Calamares', 7, 'calamares')">
                üõí A√±adir
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="order-section">
      <div class="section-header">
        <span class="section-badge">üõí Tu Pedido</span>
        <h2>Recogida en Plaza Mayor</h2>
      </div>

      <div class="order-container">
        <div class="order-cart">
          <h3>üõí Carrito</h3>
          <div id="order-items" class="order-items">
            <p class="empty-cart">Carrito vac√≠o</p>
          </div>

          <div class="order-summary">
            <div class="summary-line">
              <span>Subtotal:</span>
              <span id="subtotal">0.00‚Ç¨</span>
            </div>
            <div class="summary-line">
              <span>Descuento (15%):</span>
              <span id="discount">-0.00‚Ç¨</span>
            </div>
            <div class="summary-line total">
              <span><strong>Total:</strong></span>
              <span id="total"><strong>0.00‚Ç¨</strong></span>
            </div>
          </div>
        </div>

        <div class="order-form">
          <h3>üì¶ Datos</h3>
          <form id="orderForm">
            <div class="form-group">
              <label>Nombre *</label>
              <input type="text" id="customer-name" required>
            </div>

            <div class="form-group">
              <label>Tel√©fono *</label>
              <input type="tel" id="customer-phone" required>
            </div>

            <div class="form-group">
              <label>Comentarios</label>
              <textarea id="order-notes" rows="2"></textarea>
            </div>

            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
              <strong>üèÉ Recogida en Plaza Mayor</strong><br>
              <span style="font-size: 0.9rem;">Listo en 15-20 min</span>
            </div>

            <button type="submit" class="btn btn-primary btn-send-order" id="submit-btn">
              üì± Hacer Pedido
            </button>
          </form>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <p>¬© 2025 BARGON Madrid</p>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDjbJFg-GeioAxBAf3wh9zQ4M-CB7klx1Y",
      authDomain: "gonbar-8cd74.firebaseapp.com",
      databaseURL: "https://gonbar-8cd74-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gonbar-8cd74",
      storageBucket: "gonbar-8cd74.firebasestorage.app",
      messagingSenderId: "865095320231",
      appId: "1:865095320231:web:d6598f1ddfd93672c39182"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let cart = [];
    let isSubmitting = false;
    let lastClickTime = {};

    function addToOrder(name, price, id) {
      const now = Date.now();
      const timeSince = lastClickTime[id] ? now - lastClickTime[id] : 1000;

      if (timeSince < 500) return;
      lastClickTime[id] = now;

      const existing = cart.find(item => item.id === id);
      if (existing) {
        existing.quantity++;
      } else {
        cart.push({ id, name, price, quantity: 1 });
      }

      updateCart();
      showNotification(`‚úì ${name} a√±adido`);
    }

    function updateCart() {
      const itemsDiv = document.getElementById('order-items');
      const subtotalEl = document.getElementById('subtotal');
      const discountEl = document.getElementById('discount');
      const totalEl = document.getElementById('total');

      if (cart.length === 0) {
        itemsDiv.innerHTML = '<p class="empty-cart">Carrito vac√≠o</p>';
        subtotalEl.textContent = '0.00‚Ç¨';
        discountEl.textContent = '-0.00‚Ç¨';
        totalEl.innerHTML = '<strong>0.00‚Ç¨</strong>';
        return;
      }

      let html = '';
      let subtotal = 0;

      cart.forEach((item, idx) => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;

        html += `
          <div class="cart-item">
            <div class="cart-item-info">
              <strong>${item.name}</strong>
              <div class="cart-item-controls">
                <button onclick="changeQty(${idx}, -1)" class="btn-qty">-</button>
                <span class="qty">${item.quantity}</span>
                <button onclick="changeQty(${idx}, 1)" class="btn-qty">+</button>
              </div>
            </div>
            <div class="cart-item-price">
              <span>${itemTotal.toFixed(2)}‚Ç¨</span>
              <button onclick="removeItem(${idx})" class="btn-remove">üóëÔ∏è</button>
            </div>
          </div>
        `;
      });

      itemsDiv.innerHTML = html;

      const discount = subtotal * 0.15;
      const total = subtotal - discount;

      subtotalEl.textContent = `${subtotal.toFixed(2)}‚Ç¨`;
      discountEl.textContent = `-${discount.toFixed(2)}‚Ç¨`;
      totalEl.innerHTML = `<strong>${total.toFixed(2)}‚Ç¨</strong>`;
    }

    function changeQty(idx, delta) {
      cart[idx].quantity += delta;
      if (cart[idx].quantity <= 0) {
        cart.splice(idx, 1);
      }
      updateCart();
    }

    function removeItem(idx) {
      cart.splice(idx, 1);
      updateCart();
    }

    document.getElementById('orderForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      if (isSubmitting) return;
      if (cart.length === 0) {
        alert('‚ùå Carrito vac√≠o');
        return;
      }

      const name = document.getElementById('customer-name').value;
      const phone = document.getElementById('customer-phone').value;
      const notes = document.getElementById('order-notes').value;

      const subtotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
      const discount = subtotal * 0.15;
      const total = subtotal - discount;

      const items = cart.map(i => `‚Ä¢ ${i.quantity}x ${i.name} (${(i.price * i.quantity).toFixed(2)}‚Ç¨)`).join('\n');
      const msg = `¬øConfirmar pedido?\n\n${items}\n\nüí∞ Total: ${total.toFixed(2)}‚Ç¨\n\nüèÉ Recoge en 15-20 min`;

      if (!confirm(msg)) return;

      isSubmitting = true;
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Enviando...';

      const orderData = {
        orderNumber: Date.now(),
        timestamp: Date.now(),
        status: 'pending',
        customerName: name,
        customerPhone: phone,
        serviceType: 'pickup',
        deliveryTime: 'Inmediato',
        notes,
        items: cart,
        subtotal,
        discount,
        total,
        location: 'Madrid'
      };

      try {
        await database.ref('orders').push(orderData);
        alert('‚úÖ ¬°Pedido enviado!\nRecoge en Plaza Mayor en 15-20 min');
        cart = [];
        updateCart();
        this.reset();
      } catch (error) {
        alert('‚ùå Error al enviar');
        console.error(error);
      } finally {
        setTimeout(() => {
          isSubmitting = false;
          btn.disabled = false;
          btn.textContent = 'üì± Hacer Pedido';
        }, 2000);
      }
    });

    function showNotification(msg) {
      const div = document.createElement('div');
      div.className = 'notification';
      div.textContent = msg;
      div.style.cssText = 'position:fixed;top:20px;right:20px;background:#27ae60;color:white;padding:15px 25px;border-radius:10px;z-index:9999;animation:slideIn 0.5s';
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }
  </script>
</body>
</html>