<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BARGON Madrid | Pedidos</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <header>
    <nav>
      <div class="logo"><a href="../">üç¥ BARGON</a></div>
      <ul class="nav-links">
        <li><a href="../">üè† Inicio</a></li>
        <li><a href="../sevilla/">üåü Sevilla</a></li>
        <li><a href="../donbenito/">‚≠ê Don Benito</a></li>
      </ul>
    </nav>
  </header>

  <section class="hero" style="background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?auto=format&fit=crop&w=1400&q=80');">
    <div class="hero-content">
      <span class="hero-badge">‚ú® BARGON Madrid</span>
      <h1 class="hero-title">Sabores de la Capital</h1>
      <p class="hero-subtitle">En local o para llevar</p>
    </div>
  </section>

  <main class="container">
    <section class="recommendations-section">
      <div class="section-header">
        <span class="section-badge">‚≠ê Recomendaciones</span>
        <h2>Lo Mejor de BARGON Madrid</h2>
      </div>

      <div class="recommendations-grid">
        <div class="recommendation-card special" style="border: 3px solid #9b59b6;">
          <div class="recommendation-badge limited" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
            ‚ö° LIMITADO
          </div>
          <div class="recommendation-image">
            <img src="https://images.unsplash.com/photo-1604908554274-44cb73d88ab9?auto=format&fit=crop&w=800&q=80" alt="Zero">
          </div>
          <div class="recommendation-content">
            <h3 style="color: #9b59b6;">‚≠ê ZERO</h3>
            <p class="recommendation-description">Experiencia gastron√≥mica √∫nica.</p>
            <div class="recommendation-footer">
              <div class="price-info">
                <span class="price-old">35‚Ç¨</span>
                <span class="price-large">28‚Ç¨</span>
              </div>
              <button class="btn-add-to-order" onclick="addToOrder('Zero', 28, 'zero')">‚ö° A√±adir</button>
            </div>
          </div>
        </div>

        <div class="recommendation-card">
          <div class="recommendation-image">
            <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=800&q=80" alt="Cocido">
          </div>
          <div class="recommendation-content">
            <h3>üèÜ Cocido Madrile√±o</h3>
            <p class="recommendation-description">Tradici√≥n de tres vuelcos.</p>
            <div class="recommendation-footer">
              <div class="price-info">
                <span class="price-large">12‚Ç¨</span>
              </div>
              <button class="btn-add-to-order" onclick="addToOrder('Cocido Madrile√±o', 12, 'cocido')">üõí A√±adir</button>
            </div>
          </div>
        </div>

        <div class="recommendation-card">
          <div class="recommendation-image">
            <img src="https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80" alt="Calamares">
          </div>
          <div class="recommendation-content">
            <h3>ü¶ë Bocadillo Calamares</h3>
            <p class="recommendation-description">Frescos del d√≠a.</p>
            <div class="recommendation-footer">
              <div class="price-info">
                <span class="price-large">7‚Ç¨</span>
              </div>
              <button class="btn-add-to-order" onclick="addToOrder('Bocadillo Calamares', 7, 'calamares')">üõí A√±adir</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="order-section">
      <div class="section-header">
        <span class="section-badge">üõí Tu Pedido</span>
        <h2>Finalizar Pedido</h2>
      </div>

      <div class="order-container">
        <div class="order-cart">
          <h3>üõí Carrito</h3>
          <div id="order-items" class="order-items">
            <p class="empty-cart">Carrito vac√≠o</p>
          </div>

          <div class="order-summary">
            <div class="summary-line">
              <span>Subtotal:</span>
              <span id="subtotal">0.00‚Ç¨</span>
            </div>
            <div class="summary-line">
              <span>Descuento (15%):</span>
              <span id="discount">-0.00‚Ç¨</span>
            </div>
            <div class="summary-line total">
              <span><strong>Total:</strong></span>
              <span id="total"><strong>0.00‚Ç¨</strong></span>
            </div>
          </div>
        </div>

        <div class="order-form">
          <h3>üì¶ Datos del Pedido</h3>
          <form id="orderForm">
            <div class="form-group">
              <label>Nombre *</label>
              <input type="text" id="customer-name" required>
            </div>

            <div class="form-group">
              <label>Tel√©fono *</label>
              <input type="tel" id="customer-phone" required>
            </div>

            <div class="form-group">
              <label>Tipo de servicio *</label>
              <select id="service-type" required>
                <option value="">Selecciona...</option>
                <option value="table">üçΩÔ∏è Comer en el restaurante</option>
                <option value="pickup">üèÉ Recogida para llevar</option>
              </select>
            </div>

            <div class="form-group" id="table-group" style="display:none;">
              <label>N√∫mero de mesa *</label>
              <select id="table-number">
                <option value="">Selecciona tu mesa...</option>
                <option value="1">Mesa 1</option>
                <option value="2">Mesa 2</option>
                <option value="3">Mesa 3</option>
                <option value="4">Mesa 4</option>
                <option value="5">Mesa 5</option>
                <option value="6">Mesa 6</option>
                <option value="7">Mesa 7</option>
                <option value="8">Mesa 8</option>
                <option value="9">Mesa 9</option>
                <option value="10">Mesa 10</option>
              </select>
            </div>

            <div class="form-group">
              <label>Comentarios</label>
              <textarea id="order-notes" rows="2" placeholder="Alergias, preferencias..."></textarea>
            </div>

            <div id="info-box" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; display: none;">
              <strong id="info-title"></strong><br>
              <span id="info-text" style="font-size: 0.9rem;"></span>
            </div>

            <button type="submit" class="btn btn-primary btn-send-order" id="submit-btn">
              üì± Enviar Pedido
            </button>
          </form>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <p>¬© 2025 BARGON Madrid</p>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDjbJFg-GeioAxBAf3wh9zQ4M-CB7klx1Y",
      authDomain: "gonbar-8cd74.firebaseapp.com",
      databaseURL: "https://gonbar-8cd74-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gonbar-8cd74",
      storageBucket: "gonbar-8cd74.firebasestorage.app",
      messagingSenderId: "865095320231",
      appId: "1:865095320231:web:d6598f1ddfd93672c39182"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let cart = [];
    let isSubmitting = false;
    let lastClickTime = {};

    function addToOrder(name, price, id) {
      const now = Date.now();
      const timeSince = lastClickTime[id] ? now - lastClickTime[id] : 1000;

      if (timeSince < 500) return;
      lastClickTime[id] = now;

      const existing = cart.find(item => item.id === id);
      if (existing) {
        existing.quantity++;
      } else {
        cart.push({ id, name, price, quantity: 1 });
      }

      updateCart();
      showNotification('‚úì ' + name + ' a√±adido');
    }

    function updateCart() {
      const itemsDiv = document.getElementById('order-items');
      const subtotalEl = document.getElementById('subtotal');
      const discountEl = document.getElementById('discount');
      const totalEl = document.getElementById('total');

      if (cart.length === 0) {
        itemsDiv.innerHTML = '<p class="empty-cart">Carrito vac√≠o</p>';
        subtotalEl.textContent = '0.00‚Ç¨';
        discountEl.textContent = '-0.00‚Ç¨';
        totalEl.innerHTML = '<strong>0.00‚Ç¨</strong>';
        return;
      }

      let html = '';
      let subtotal = 0;

      cart.forEach((item, idx) => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;

        html += '<div class="cart-item">';
        html += '<div class="cart-item-info">';
        html += '<strong>' + item.name + '</strong>';
        html += '<div class="cart-item-controls">';
        html += '<button onclick="changeQty(' + idx + ', -1)" class="btn-qty">-</button>';
        html += '<span class="qty">' + item.quantity + '</span>';
        html += '<button onclick="changeQty(' + idx + ', 1)" class="btn-qty">+</button>';
        html += '</div></div>';
        html += '<div class="cart-item-price">';
        html += '<span>' + itemTotal.toFixed(2) + '‚Ç¨</span>';
        html += '<button onclick="removeItem(' + idx + ')" class="btn-remove">üóëÔ∏è</button>';
        html += '</div></div>';
      });

      itemsDiv.innerHTML = html;

      const discount = subtotal * 0.15;
      const total = subtotal - discount;

      subtotalEl.textContent = subtotal.toFixed(2) + '‚Ç¨';
      discountEl.textContent = '-' + discount.toFixed(2) + '‚Ç¨';
      totalEl.innerHTML = '<strong>' + total.toFixed(2) + '‚Ç¨</strong>';
    }

    function changeQty(idx, delta) {
      cart[idx].quantity += delta;
      if (cart[idx].quantity <= 0) {
        cart.splice(idx, 1);
      }
      updateCart();
    }

    function removeItem(idx) {
      cart.splice(idx, 1);
      updateCart();
    }

    document.getElementById('service-type').addEventListener('change', function() {
      const tableGroup = document.getElementById('table-group');
      const infoBox = document.getElementById('info-box');
      const infoTitle = document.getElementById('info-title');
      const infoText = document.getElementById('info-text');

      if (this.value === 'table') {
        tableGroup.style.display = 'block';
        infoBox.style.display = 'block';
        infoBox.style.background = '#e8f5e9';
        infoTitle.textContent = 'üçΩÔ∏è Comer en el restaurante';
        infoText.textContent = 'Selecciona tu mesa. Te traeremos el pedido a la mesa.';
      } else if (this.value === 'pickup') {
        tableGroup.style.display = 'none';
        infoBox.style.display = 'block';
        infoBox.style.background = '#fff3e0';
        infoTitle.textContent = 'üèÉ Recogida en Plaza Mayor';
        infoText.textContent = 'Listo en 15-20 minutos. Te avisaremos cuando est√© preparado.';
      } else {
        tableGroup.style.display = 'none';
        infoBox.style.display = 'none';
      }
    });

    document.getElementById('orderForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      if (isSubmitting) return;
      if (cart.length === 0) {
        alert('‚ùå Carrito vac√≠o');
        return;
      }

      const name = document.getElementById('customer-name').value;
      const phone = document.getElementById('customer-phone').value;
      const serviceType = document.getElementById('service-type').value;
      const tableNumber = document.getElementById('table-number').value;
      const notes = document.getElementById('order-notes').value;

      if (serviceType === 'table' && !tableNumber) {
        alert('‚ùå Selecciona el n√∫mero de mesa');
        return;
      }

      const subtotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
      const discount = subtotal * 0.15;
      const total = subtotal - discount;

      let itemsList = '';
      cart.forEach(i => {
        itemsList += '‚Ä¢ ' + i.quantity + 'x ' + i.name + ' (' + (i.price * i.quantity).toFixed(2) + '‚Ç¨)\n';
      });

      let msg = '¬øConfirmar pedido?\n\n' + itemsList + '\nüí∞ Total: ' + total.toFixed(2) + '‚Ç¨\n\n';

      if (serviceType === 'table') {
        msg += 'üçΩÔ∏è Mesa ' + tableNumber + '\nTe lo traeremos a la mesa';
      } else {
        msg += 'üèÉ Recogida en 15-20 min';
      }

      if (!confirm(msg)) return;

      isSubmitting = true;
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Enviando...';

      const orderData = {
        orderNumber: Date.now(),
        timestamp: Date.now(),
        status: serviceType === 'table' ? 'occupied' : 'pending',
        customerName: name,
        customerPhone: phone,
        serviceType: serviceType,
        tableNumber: serviceType === 'table' ? parseInt(tableNumber) : null,
        deliveryTime: 'Inmediato',
        notes: notes || '',
        items: cart,
        subtotal: subtotal,
        discount: discount,
        total: total,
        location: 'Madrid'
      };

      try {
        if (serviceType === 'table') {
          const tableRef = database.ref('tables/' + tableNumber);
          const snapshot = await tableRef.once('value');

          if (snapshot.exists()) {
            const existingOrder = snapshot.val();
            const updatedItems = existingOrder.items.slice();

            cart.forEach(newItem => {
              const existingItemIndex = updatedItems.findIndex(item => item.id === newItem.id);
              if (existingItemIndex >= 0) {
                updatedItems[existingItemIndex].quantity += newItem.quantity;
              } else {
                updatedItems.push(newItem);
              }
            });

            const newSubtotal = updatedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const newDiscount = newSubtotal * 0.15;
            const newTotal = newSubtotal - newDiscount;

            await tableRef.update({
              items: updatedItems,
              subtotal: newSubtotal,
              discount: newDiscount,
              total: newTotal,
              timestamp: Date.now()
            });

            alert('‚úÖ ¬°Items a√±adidos a Mesa ' + tableNumber + '!\n\nTotal actualizado: ' + newTotal.toFixed(2) + '‚Ç¨');
          } else {
            await tableRef.set(orderData);
            alert('‚úÖ ¬°Pedido enviado!\n\nMesa ' + tableNumber + '\nTe lo traeremos enseguida');
          }
        } else {
          await database.ref('orders').push(orderData);
          alert('‚úÖ ¬°Pedido enviado!\n\nRecoge en Plaza Mayor en 15-20 min');
        }

        cart = [];
        updateCart();
        this.reset();
      } catch (error) {
        alert('‚ùå Error al enviar pedido: ' + error.message);
        console.error('Error:', error);
      } finally {
        setTimeout(() => {
          isSubmitting = false;
          btn.disabled = false;
          btn.textContent = 'üì± Enviar Pedido';
        }, 2000);
      }
    });

    function showNotification(msg) {
      const div = document.createElement('div');
      div.className = 'notification';
      div.textContent = msg;
      div.style.cssText = 'position:fixed;top:20px;right:20px;background:#27ae60;color:white;padding:15px 25px;border-radius:10px;z-index:9999;animation:slideIn 0.5s';
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }
  </script>
</body>
</html>