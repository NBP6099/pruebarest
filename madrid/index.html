<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BARGON Madrid | Sistema de Pedidos</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <header>
    <nav>
      <div class="logo"><a href="../">🍴 BARGON</a></div>
      <ul class="nav-links">
        <li><a href="../">🏠 Inicio</a></li>
        <li><a href="../sevilla/">🌟 Sevilla</a></li>
        <li><a href="../donbenito/">⭐ Don Benito</a></li>
      </ul>
    </nav>
  </header>

  <section class="hero" style="background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?auto=format&fit=crop&w=1400&q=80');">
    <div class="hero-content">
      <span class="hero-badge">✨ BARGON Madrid</span>
      <h1 class="hero-title">Sabores de la Capital</h1>
      <p class="hero-subtitle">Pedidos online con entrega inmediata</p>
    </div>
  </section>

  <section class="promo-banner">
    <div class="container">
      <div class="promo-content">
        <span class="promo-icon">🎉</span>
        <div class="promo-text">
          <strong>¡Nuevo!</strong> Zero - Plato Estrella Limitado
        </div>
        <a href="#recomendaciones" class="promo-cta">Ver Ahora</a>
      </div>
    </div>
  </section>

  <main class="container">
    <section class="recommendations-section" id="recomendaciones">
      <div class="section-header">
        <span class="section-badge">⭐ Recomendaciones del Chef</span>
        <h2>Lo Mejor de BARGON Madrid</h2>
      </div>

      <div class="recommendations-grid">
        <!-- PLATO ZERO ESTRELLA -->
        <div class="recommendation-card special" style="border: 3px solid #9b59b6;">
          <div class="recommendation-badge limited" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
            ⚡ ¡LIMITADO! - Plato del Mes
          </div>
          <div class="recommendation-image">
            <img src="https://images.unsplash.com/photo-1604908554274-44cb73d88ab9?auto=format&fit=crop&w=800&q=80" alt="Zero">
          </div>
          <div class="recommendation-content">
            <h3 style="color: #9b59b6;">⭐ ZERO - El Plato Estrella</h3>
            <p class="recommendation-description">
              Una experiencia gastronómica revolucionaria que fusiona técnicas de alta cocina con sabores tradicionales madrileños.
            </p>
            <div class="recommendation-details">
              <span class="detail">🔥 Top 1 del mes</span>
              <span class="detail">🌿 Orgánico</span>
              <span class="detail">⏱️ 2h preparación</span>
              <span class="detail">💎 Limitado</span>
            </div>
            <div class="recommendation-footer">
              <div class="price-info">
                <span class="price-old">35€</span>
                <span class="price-large">28€</span>
              </div>
              <button class="btn-add-to-order" onclick="addToOrder('Zero - Plato Estrella', 28, 'madrid-zero')">
                ⚡ Añadir
              </button>
            </div>
          </div>
        </div>

        <!-- Cocido -->
        <div class="recommendation-card special">
          <div class="recommendation-badge">👨‍🍳 Chef's Choice</div>
          <div class="recommendation-image">
            <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=800&q=80" alt="Cocido">
          </div>
          <div class="recommendation-content">
            <h3>🏆 Cocido Madrileño</h3>
            <p class="recommendation-description">Receta tradicional de tres vuelcos.</p>
            <div class="recommendation-footer">
              <div class="price-info">
                <span class="price-large">12€</span>
              </div>
              <button class="btn-add-to-order" onclick="addToOrder('Cocido Madrileño', 12, 'madrid-001')">
                🛒 Añadir
              </button>
            </div>
          </div>
        </div>

        <!-- Calamares -->
        <div class="recommendation-card">
          <div class="recommendation-badge trending">🔥 Trending</div>
          <div class="recommendation-image">
            <img src="https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80" alt="Calamares">
          </div>
          <div class="recommendation-content">
            <h3>🦑 Bocadillo de Calamares</h3>
            <p class="recommendation-description">Frescos del día, rebozado crujiente.</p>
            <div class="recommendation-footer">
              <div class="price-info">
                <span class="price-large">7€</span>
              </div>
              <button class="btn-add-to-order" onclick="addToOrder('Bocadillo Calamares', 7, 'madrid-002')">
                🛒 Añadir
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="order-section" id="pedidos">
      <div class="section-header">
        <span class="section-badge">🛒 Tu Pedido</span>
        <h2>Finalizar Compra</h2>
      </div>

      <div class="order-container">
        <div class="order-cart">
          <h3>🛒 Carrito</h3>
          <div id="order-items" class="order-items">
            <p class="empty-cart">Tu carrito está vacío</p>
          </div>

          <div class="order-summary">
            <div class="summary-line">
              <span>Subtotal:</span>
              <span id="subtotal">0.00€</span>
            </div>
            <div class="summary-line">
              <span>Descuento (15%):</span>
              <span id="discount" class="discount-amount">-0.00€</span>
            </div>
            <div class="summary-line total">
              <span><strong>Total:</strong></span>
              <span id="total"><strong>0.00€</strong></span>
            </div>
          </div>
        </div>

        <div class="order-form">
          <h3>📦 Datos de Entrega</h3>
          <form id="orderForm">
            <div class="form-group">
              <label>Nombre completo *</label>
              <input type="text" id="customer-name" required>
            </div>

            <div class="form-group">
              <label>Teléfono *</label>
              <input type="tel" id="customer-phone" required>
            </div>

            <div class="form-group">
              <label>Tipo de servicio *</label>
              <select id="service-type" required>
                <option value="">Selecciona...</option>
                <option value="delivery">🏠 Entrega a domicilio</option>
                <option value="pickup">🏃 Recogida en local</option>
                <option value="table">🍽️ Comer en restaurante</option>
              </select>
            </div>

            <div class="form-group" id="address-group" style="display:none;">
              <label>Dirección de entrega *</label>
              <input type="text" id="delivery-address">
            </div>

            <div class="form-group" id="table-group" style="display:none;">
              <label>Número de mesa</label>
              <input type="text" id="table-number">
            </div>

            <div class="form-group">
              <label>Comentarios</label>
              <textarea id="order-notes" rows="3"></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-send-order" id="submit-btn">
              📱 Enviar Pedido
            </button>
          </form>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <p>© 2025 BARGON Madrid — Plaza Mayor</p>
    </div>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDjbJFgGeioAxBAf3wh9zQ4M-CB7klx1Y",
      authDomain: "gonbar-8cd74.firebaseapp.com",
      databaseURL: "https://gonbar-8cd74-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gonbar-8cd74",
      storageBucket: "gonbar-8cd74.firebasestorage.app",
      messagingSenderId: "865095320231",
      appId: "1:865095320231:web:d6598f1ddfd93672c39182",
      measurementId: "G-M6ZNWVBQ88"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let cart = [];
    let orderNumber = Date.now();
    let isSubmitting = false; // PREVENIR DUPLICADOS
    let lastClickTime = {}; // DEBOUNCE POR PRODUCTO

    // ✅ MEJORADO: Añadir con DEBOUNCE (500ms entre clicks)
    function addToOrder(name, price, id) {
      const now = Date.now();
      const timeSinceLastClick = lastClickTime[id] ? now - lastClickTime[id] : 1000;

      // Si pasaron menos de 500ms, ignorar
      if (timeSinceLastClick < 500) {
        return;
      }

      lastClickTime[id] = now;

      const existingItem = cart.find(item => item.id === id);

      if (existingItem) {
        existingItem.quantity++;
      } else {
        cart.push({ id, name, price, quantity: 1 });
      }

      updateCart();
      showNotification(`✓ ${name} añadido`);
    }

    function updateCart() {
      const orderItems = document.getElementById('order-items');
      const subtotalEl = document.getElementById('subtotal');
      const discountEl = document.getElementById('discount');
      const totalEl = document.getElementById('total');

      if (cart.length === 0) {
        orderItems.innerHTML = '<p class="empty-cart">Tu carrito está vacío</p>';
        subtotalEl.textContent = '0.00€';
        discountEl.textContent = '-0.00€';
        totalEl.innerHTML = '<strong>0.00€</strong>';
        return;
      }

      let html = '';
      let subtotal = 0;

      cart.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;

        html += `
          <div class="cart-item">
            <div class="cart-item-info">
              <strong>${item.name}</strong>
              <div class="cart-item-controls">
                <button onclick="changeQuantity(${index}, -1)" class="btn-qty">-</button>
                <span class="qty">${item.quantity}</span>
                <button onclick="changeQuantity(${index}, 1)" class="btn-qty">+</button>
              </div>
            </div>
            <div class="cart-item-price">
              <span>${itemTotal.toFixed(2)}€</span>
              <button onclick="removeItem(${index})" class="btn-remove">🗑️</button>
            </div>
          </div>
        `;
      });

      orderItems.innerHTML = html;

      const discount = subtotal * 0.15;
      const total = subtotal - discount;

      subtotalEl.textContent = `${subtotal.toFixed(2)}€`;
      discountEl.textContent = `-${discount.toFixed(2)}€`;
      totalEl.innerHTML = `<strong>${total.toFixed(2)}€</strong>`;
    }

    function changeQuantity(index, delta) {
      cart[index].quantity += delta;
      if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
      }
      updateCart();
    }

    function removeItem(index) {
      cart.splice(index, 1);
      updateCart();
    }

    document.getElementById('service-type').addEventListener('change', function() {
      const addressGroup = document.getElementById('address-group');
      const tableGroup = document.getElementById('table-group');

      addressGroup.style.display = 'none';
      tableGroup.style.display = 'none';

      if (this.value === 'delivery') {
        addressGroup.style.display = 'block';
      } else if (this.value === 'table') {
        tableGroup.style.display = 'block';
      }
    });

    // ✅ MEJORADO: Enviar con CONFIRMACIÓN y PREVENIR DUPLICADOS
    document.getElementById('orderForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Prevenir envíos duplicados
      if (isSubmitting) {
        return;
      }

      if (cart.length === 0) {
        alert('❌ Tu carrito está vacío');
        return;
      }

      const customerName = document.getElementById('customer-name').value;
      const customerPhone = document.getElementById('customer-phone').value;
      const serviceType = document.getElementById('service-type').value;
      const deliveryAddress = document.getElementById('delivery-address').value;
      const tableNumber = document.getElementById('table-number').value;
      const notes = document.getElementById('order-notes').value;

      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const discount = subtotal * 0.15;
      const total = subtotal - discount;

      // ✅ CONFIRMACIÓN antes de enviar
      const itemsList = cart.map(item => `• ${item.quantity}x ${item.name} (${(item.price * item.quantity).toFixed(2)}€)`).join('\n');
      const confirmMessage = `¿Confirmar pedido?\n\n${itemsList}\n\n💰 Total: ${total.toFixed(2)}€`;

      if (!confirm(confirmMessage)) {
        return;
      }

      // Bloquear botón
      isSubmitting = true;
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = '⏳ Enviando...';

      const orderData = {
        orderNumber: orderNumber++,
        timestamp: Date.now(),
        status: 'pending',
        customerName,
        customerPhone,
        serviceType,
        deliveryAddress: serviceType === 'delivery' ? deliveryAddress : null,
        tableNumber: serviceType === 'table' ? tableNumber : null,
        deliveryTime: 'Inmediato', // ✅ SIEMPRE INMEDIATO
        notes,
        items: cart,
        subtotal,
        discount,
        total,
        location: 'Madrid'
      };

      try {
        await database.ref('orders').push(orderData);
        alert('✅ ¡Pedido enviado correctamente!');
        cart = [];
        updateCart();
        this.reset();
      } catch (error) {
        alert('❌ Error al enviar el pedido. Inténtalo de nuevo.');
        console.error(error);
      } finally {
        // Desbloquear botón después de 2 segundos
        setTimeout(() => {
          isSubmitting = false;
          submitBtn.disabled = false;
          submitBtn.textContent = '📱 Enviar Pedido';
        }, 2000);
      }
    });

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }
  </script>
</body>
</html>
